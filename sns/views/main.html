{% extends 'layout.html' %}
<!-- 
    1. Î°úÍ∑∏Ïù∏ O => Í≤åÏãúÍ∏Ä ÏûëÏÑ±(Form) + [ÏÇ¨ÏßÑÏóÖÎ°úÎìú] Î≤ÑÌäº
    2. Ìï¥ÏãúÌÉúÍ∑∏ Í≤ÄÏÉâ
    3. twits ÎûúÎçîÎßÅ + [ÌåîÎ°úÏö∞] Î≤ÑÌäº
 -->
{% block content %}
    <div class="timeline">
      <!-- üëá 1. Î°úÍ∑∏Ïù∏ O => Í≤åÏãúÍ∏Ä ÏûëÏÑ±(Form) -->
      {% if user %}
        <div>
          <form id="twit-form" action="/post" method="post" enctype="multipart/form-data">
            <div class="input-group">
              <textarea id="twit" name="content" maxlength="140"></textarea>
            </div>
            <div class="img-preview">
              <img id="img-preview" src="" style="display: none;" width="250" alt="ÎØ∏Î¶¨Î≥¥Í∏∞">
              <input id="img-url" type="hidden" name="url"> <!--  Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏùò URL(Ïç∏ÎÑ§Ïùº)ÏùÑ ÏÑúÎ≤ÑÎ°ú Ï†ÑÎã¨ -->
            </div>
            <div>
              <label id="img-label" for="img">ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú</label> <!-- üëà [ÏÇ¨ÏßÑÏóÖÎ°úÎìú] Î≤ÑÌäº -->
              <input id="img" type="file" accept="image/*">
              <button id="twit-btn" type="submit" class="btn">Ï†úÏ∂ú</button>
            </div>
          </form>
        </div>
      {% endif %}
      <div class="twits">
        <!-- üëá 2. Ìï¥ÏãúÌÉúÍ∑∏ Í≤ÄÏÉâ -->
        <form id="hashtag-form" action="/hashtag">    <!-- <form>ÏóêÏÑú methodÏùò Í∏∞Î≥∏Í∞íÏù¥ GETÏù¥ÎØÄÎ°ú, ÏøºÎ¶¨Ïä§Ìä∏ÎßÅÏúºÎ°ú Ï†ÑÎã¨ Îê® (ÏÑúÎ≤ÑÏóêÏÑú req.query.hashtagÎ°ú Î∞õÏùå) -->
          <input type="text" name="hashtag" placeholder="ÌÉúÍ∑∏ Í≤ÄÏÉâ">
          <button class="btn">Í≤ÄÏÉâ</button>
        </form>
        <!-- üëá 3. twits ÎûúÎçîÎßÅ -->
        {% for twit in twits %}
          <div class="twit">
            <!-- ÏÇ¨Ïö©Ïûê Î™∞Îûò ÏÑúÎ≤ÑÎ°ú Î≥¥ÎÇº Îç∞Ïù¥ÌÑ∞ (Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú, javascriptÎ°ú Îç∞Ïù¥ÌÑ∞ Î≥¥ÎÉÑ) -->
            <input type="hidden" value="{{twit.User.id}}" class="twit-user-id">
            <input type="hidden" value="{{twit.id}}" class="twit-id">
            <!-- ÏûëÏÑ±Ïûê -->
            {% if disableLink %} <!-- ÏûëÏÑ±ÏûêÏùò Í≤åÏãúÎ¨ºÎì§ Ï°∞Ìöå Ïãú, ÏûëÏÑ±Ïûê ÎßÅÌÅ¨ Ï†úÍ±∞ -->
              <span style="font-weight: bold;">{{ twit.User.nick }}</span>
            {% else %}
              <a class="twit-author" style="font-weight: bold; color: rgb(17, 79, 214);" href="post/{{twit.User.id}}">{{ twit.User.nick }}</a>  <!-- üëà ÏûëÏÑ±Ïûê -->
            {% endif %}
            {% if not followingIdList.includes(twit.User.id) and twit.User.id !== user.id and user.id %}
              <button class="twit-follow">ÌåîÎ°úÏö∞</button>  <!-- üëà [ÌåîÎ°úÏö∞] Î≤ÑÌäº -->
            {% endif %}
            {% if followingIdList.includes(twit.User.id) and twit.User.id !== user.id %}
              <button class="twit-unfollow">Ïñ∏ÌåîÎ°úÏö∞</button>  <!-- üëà [Ïñ∏ÌåîÎ°úÏö∞] Î≤ÑÌäº -->
            {% endif %}
            {% if twit.User.id === user.id %}
              <button class="twit-update">Í∏Ä ÏàòÏ†ï</button>  <!-- üëà [Í∏Ä ÏàòÏ†ï] Î≤ÑÌäº -->
              <button class="twit-delete">Í∏Ä ÏÇ≠Ï†ú</button>  <!-- üëà [Í∏Ä ÏÇ≠Ï†ú] Î≤ÑÌäº -->
            {% endif %}
            <!-- #Ìï¥ÏãúÌÉúÍ∑∏ ÎßÅÌÅ¨ -->
            {% for hashtag in twit.Hashtags %}
              <a href="/hashtag?hashtag={{ hashtag.title }}" style="color: royalblue; text-decoration: none; margin-left: 10px;">#{{ hashtag.title }}</a> 
            {% endfor %}
            <!-- Ï¢ãÏïÑÏöî {{ LikePostsIdList }} -->
            {% if LikePostsIdList.includes(twit.id) %} <!-- (routes/page)ÏóêÏÑú res.locals.LikePostsIdList ÏúºÎ°ú Ï†ÑÎã¨ -->
              <a href="/post/dislike/{{ twit.id }}" style="float: right; text-decoration: none;">‚ù§Ô∏è <span style="color: crimson;">{{ twit.likes }}</span></a> 
            {% else %}
              <a href="/post/like/{{ twit.id }}" style="float: right; text-decoration: none;">ü§ç <span style="color: crimson;">{{ twit.likes }}</span></a> 
            {% endif %}
            <!-- Î≥∏Î¨∏ -->
            <div class="twit-content" style="margin-top: 10px;">{{twit.content}}</div>
            <!-- üëá Í≤åÏãúÍ∏Ä Ïù¥ÎØ∏ÏßÄ (Ïç∏ÎÑ§Ïùº) -->  
            {% if twit.img %}
              <div class="twit-img">
                <img src="{{twit.img}}" onerror="this.src = this.src.replace(/\/thumb\//, '/original/');" alt="ÏÑ¨ÎÑ§Ïùº"> <!-- Ïã§Ìå®ÌïòÎ©¥, ÏõêÎ≥∏ Î°úÎî© -->
              </div>
            {% endif %}


            <!-- ÎåìÍ∏Ä ÏûÖÎ†•Ï∞Ω -->
            {% if user %}
            <div class="comment-input" style="font-size: 0.9em; background-color: #f1f1f1; padding: 9px; border-radius: 10px; margin-top: 20px; display: flex; align-items: center;">
              <input class="userId" type="hidden" name="userId" value="{{user.id}}"> <!-- Î°úÍ∑∏Ïù∏Ìïú Ïú†Ï†Ä -->
              <input class="postUserId" type="hidden" name="postUserId" value="{{ twit.User.id }}"> <!-- Í≤åÏãúÍ∏Ä ÏûëÏÑ±Ïûê -->
              <input class="postId" type="hidden" name="postId" value="{{ twit.id }}"> <!-- Ïñ¥Îñ§ Í≤åÏãúÍ∏Ä(postId)Ïùò ÎåìÍ∏ÄÏù∏ÏßÄ ÌëúÏãúÌïòÍ∏∞ ÏúÑÌï® -->
              <input class="commentId" type="hidden" name="commentId" value=""> <!-- Ïñ¥Îñ§ ÎåìÍ∏Ä(commentId)Ïùò ÎåÄÎåìÍ∏ÄÏù∏ÏßÄ ÌëúÏãúÌïòÍ∏∞ ÏúÑÌï® -->
              <span style="margin-right: 10px; font-weight: bold;">{{ user.nick }}:</span>
              <input class="comment-text" placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." style="flex: 1;"></input>
              <button class="comment-submit" style="margin-left: 10px; border: 1px solid silver; border-radius: 4px; padding: 5px;">Îì±Î°ù</button>
            </div>
            {% endif %}

            <!-- ÎåìÍ∏Ä Î™©Î°ù -->
            {% if twit.Comments.length > 0 %} 
              <div class="comment-section" style="font-size: 0.9em; border: 1px solid silver; border-radius: 4px; padding: 10px; position: relative; margin-top: 10px; margin-bottom: 10px;">
                {% for comment in twit.Comments %}
                  <!-- ÎåìÍ∏Ä -->
                  <div class="comment">
                      <a href="/post/{{ comment.User.id }}" style="font-weight: bold; color: black;">{{ comment.User.nick }}</a>: {{ comment.content }}
                      {% if user %}
                        <button class="addReply reply-btn" style="margin-left: 15px;" value="{{ comment.id }}">ÎãµÍ∏Ä</button>
                        <!-- ÎãµÍ∏Ä ÏûÖÎ†•Ï∞Ω -->
                        <div class="reply-input" style="display: none;">
                          <div class="reply-input" style="font-size: 0.9em; background-color: #f1f1f1; padding: 9px; border-radius: 10px; margin-left: 10px; margin-top: 10px; margin-bottom: 10px; display: flex; align-items: center;">
                            <input class="userId" type="hidden" name="userId" value="{{user.id}}"> <!-- Î°úÍ∑∏Ïù∏Ìïú Ïú†Ï†Ä -->
                            <input class="postUserId" type="hidden" name="postUserId" value="{{ twit.User.id }}"> <!-- Í≤åÏãúÍ∏Ä ÏûëÏÑ±Ïûê -->
                            <input class="postId" type="hidden" name="postId" value="{{ twit.id }}"> <!-- Ïñ¥Îñ§ Í≤åÏãúÍ∏Ä(postId)Ïùò ÎåìÍ∏ÄÏù∏ÏßÄ ÌëúÏãúÌïòÍ∏∞ ÏúÑÌï® -->
                            <input class="commentId" type="hidden" name="commentId" value="{{ comment.id }}"> <!-- Ïñ¥Îñ§ ÎåìÍ∏Ä(commentId)Ïùò ÎåÄÎåìÍ∏ÄÏù∏ÏßÄ ÌëúÏãúÌïòÍ∏∞ ÏúÑÌï® -->
                            <span style="margin-right: 10px; font-weight: bold;">{{ user.nick }}:</span>
                            <input class="reply-text" placeholder="ÎãµÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." style="flex: 1;"></input>
                            <button class="reply-submit" style="margin-left: 10px; border: 1px solid silver; border-radius: 4px; padding: 5px;">Îì±Î°ù</button>
                          </div>
                        </div>
                      {% endif %}
                      <!-- ÎãµÍ∏Ä Î™©Î°ù -->
                      {% for reply in comment.Replies %}
                        <div>
                          ‚îó <a href="/post/{{ comment.User.id }}" style="font-weight: bold; color: black;">{{ reply.User.nick }}</a>: {{ reply.content }}
                        </div>
                      {% endfor %}
                  </div>
                {% endfor %}
              </div>
            {% endif %}

          </div>
        {% endfor %}
      </div>
    </div>
{% endblock %}

{% block script %}
  <script>  
    // üëá [ÏÇ¨ÏßÑÏóÖÎ°úÎìú] Î≤ÑÌäº - ÌååÏùº ÏÑ†ÌÉùÌïòÏûêÎßàÏûê, '/post/img'Î°ú Î∞îÎ°ú Ï†ÑÏÜ° Îê®
    if (document.getElementById('img')) {
      document.getElementById('img').addEventListener('change', function(e) {
        const formData = new FormData();
        console.log(this, this.files);
        formData.append('img', this.files[0]);
        axios.post('/post/img', formData)
          .then((res) => {
            document.getElementById('img-url').value = res.data.url; // ÏÑ†ÌÉùÌïú Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏùò URL(Ïç∏ÎÑ§Ïùº)ÏùÑ ÏÑúÎ≤ÑÎ°ú Ï†ÑÎã¨Ìï¥ÏÑú Post ÏÉùÏÑ±
            // üëá ÎØ∏Î¶¨ Î≥¥Í∏∞ (ÏõêÎ≥∏)
            document.getElementById('img-preview').src = res.data.originalUrl; // Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ 
            document.getElementById('img-preview').style.display = 'inline';
          })
          .catch((err) => {
            console.error(err);
          });
      });
    }
    // üëá [ÌåîÎ°úÏö∞] Î≤ÑÌäº
    document.querySelectorAll('.twit-follow').forEach(function(tag) {
      tag.addEventListener('click', function() {
        const myId = document.querySelector('#my-id');
        if (myId) {
          const userId = tag.parentNode.querySelector('.twit-user-id').value; // ÏûëÏÑ±Ïûê ID
          if (userId !== myId.value) {                                        // ÏûëÏÑ±ÏûêID !==  ÎÇò
            if (confirm('ÌåîÎ°úÏö∞ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
              axios.post(`/user/${userId}/follow`)
                .then(() => {
                  location.reload();
                })
                .catch((err) => {
                  console.error(err);
                });
            }
          }
        }
      });
    });

    // üëá [Ïñ∏ÌåîÎ°úÏö∞] Î≤ÑÌäº
    document.querySelectorAll('.twit-unfollow').forEach(function(tag) {
      tag.addEventListener('click', function() {
        const myId = document.querySelector('#my-id');
        if (myId) {
          const userId = tag.parentNode.querySelector('.twit-user-id').value; // ÏûëÏÑ±Ïûê ID
          if (userId !== myId.value) {                                        // ÏûëÏÑ±ÏûêID !==  ÎÇò
            if (confirm('Ïñ∏ÌåîÎ°úÏö∞ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
              axios.post(`/user/${userId}/unfollow`)
                .then(() => {
                  location.reload();
                })
                .catch((err) => {
                  console.error(err);
                });
            }
          }
        }
      });
    });

    // üëá [Í∏Ä ÏàòÏ†ï] Î≤ÑÌäº
    document.querySelectorAll('.twit-update').forEach(function(tag) {
      tag.addEventListener('click', function() {
        const myId = document.querySelector('#my-id');
        if (myId) {
          const userId = tag.parentNode.querySelector('.twit-user-id').value;     // ÏûëÏÑ±Ïûê ID
          if (userId === myId.value) {                                            // ÏûëÏÑ±ÏûêID ===  ÎÇò
            if (confirm('ÏàòÏ†ï ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
              const postId = tag.parentNode.querySelector('.twit-id').value;      // Í≤åÏãúÍ∏Ä ID
              window.location.href=`/update/${postId}`                            // ÌéòÏù¥ÏßÄ Ïù¥Îèô (/update/${postId})
            }
          }
        }
      });
    });

    // üëá [Í∏Ä ÏÇ≠Ï†ú] Î≤ÑÌäº
    document.querySelectorAll('.twit-delete').forEach(function(tag) {
      tag.addEventListener('click', function() {
        const myId = document.querySelector('#my-id');
        if (myId) {
          const userId = tag.parentNode.querySelector('.twit-user-id').value;   // ÏûëÏÑ±Ïûê ID
          if (userId === myId.value) {                                          // ÏûëÏÑ±Ïûê ID ===  ÎÇò
            if (confirm('ÏÇ≠Ï†ú ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
              const postId = tag.parentNode.querySelector('.twit-id').value;    // Í≤åÏãúÍ∏Ä ID
              axios.post(`/post/delete/${postId}`)
                .then(() => {
                  location.reload();
                })
                .catch((err) => {
                  console.error(err);
                });
            }
          }
        }
      });
    });


    // üëá ÎåìÍ∏Ä
    document.querySelectorAll('.comment-submit').forEach(function (submitBtn) {
      submitBtn.addEventListener('click', function () {
        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑàÏóêÏÑú submitBtnÏùÑ ÌÅ¥Î¶≠Ìïú Î≤ÑÌäºÏúºÎ°ú ÏÇ¨Ïö©
        const content = submitBtn.parentNode.querySelector('.comment-text').value;
        const userId = submitBtn.parentNode.querySelector('.userId').value;
        const postUserId = submitBtn.parentNode.querySelector('.postUserId').value;
        const postId = submitBtn.parentNode.querySelector('.postId').value;
        const commentId = submitBtn.parentNode.querySelector('.commentId').value;

        // JSON Í∞ùÏ≤¥ ÏÉùÏÑ±
        const jsonData = {
          content,
          userId,
          postUserId,
          postId,
          commentId,
        };

        // ÏÑúÎ≤ÑÎ°ú Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ°
        axios
          .post(`/comment/${postId}`, jsonData)
          .then(() => {
            window.location.href = '/';
          })
          .catch((error) => {
            console.error('ÏóêÎü¨ Î∞úÏÉù:', error);
            // ÏóêÎü¨ Ï≤òÎ¶¨ Ï∂îÍ∞Ä
          });
      });
    });      
    
    // üëá [ÎãµÍ∏Ä] Î≤ÑÌäº => ÏûÖÎ†•Ï∞Ω 
    document.querySelectorAll('.addReply').forEach(function (replyBtn) {
      replyBtn.addEventListener('click', function () {
        console.log('ÎãµÍ∏Ä ÏûÖÎ†•Ï∞Ω')
        const replyInput = replyBtn.nextElementSibling; // ÌòïÏ†ú ÏöîÏÜå Ï§ë Îã§Ïùå ÏöîÏÜåÎ•º Í∞ÄÏ†∏Ïò¥
        if (replyInput.style.display === 'none') {
          replyInput.style.display = 'inline'; // ÎåÄÎåìÍ∏Ä ÏûÖÎ†•Ï∞ΩÏùÑ Î≥¥Ïó¨Ï§å
        } else {
          replyInput.style.display = 'none'; // ÎåÄÎåìÍ∏Ä ÏûÖÎ†•Ï∞ΩÏùÑ Ïà®ÍπÄ
        }
      });
    });      

    // üëá ÎãµÍ∏Ä
    document.querySelectorAll('.reply-submit').forEach(function (replyBtn) {
      replyBtn.addEventListener('click', function () {
        console.log('ÎãµÍ∏Ä Ï†úÏ∂ú')
        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑàÏóêÏÑú submitBtnÏùÑ ÌÅ¥Î¶≠Ìïú Î≤ÑÌäºÏúºÎ°ú ÏÇ¨Ïö©
        const content = replyBtn.parentNode.querySelector('.reply-text').value;
        const userId = replyBtn.parentNode.querySelector('.userId').value;
        const postUserId = replyBtn.parentNode.querySelector('.postUserId').value;
        const postId = replyBtn.parentNode.querySelector('.postId').value;
        const commentId = replyBtn.parentNode.querySelector('.commentId').value;

        // JSON Í∞ùÏ≤¥ ÏÉùÏÑ±
        const jsonData = {
          content,
          userId,
          postUserId,
          postId,
          commentId,
        };

        // ÏÑúÎ≤ÑÎ°ú Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ°
        axios
          .post(`/comment/reply/${commentId}`, jsonData)
          .then(() => {
            window.location.href = '/';
          })
          .catch((error) => {
            console.error('ÏóêÎü¨ Î∞úÏÉù:', error);
            // ÏóêÎü¨ Ï≤òÎ¶¨ Ï∂îÍ∞Ä
          });
      });
    });  

  </script>
{% endblock %}